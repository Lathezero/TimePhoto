// 真正的二维码生成库 - 基于简化的QR算法
window.QRCode = {
    toCanvas: function(container, text, options, callback) {
        try {
            const size = (options && options.width) ? options.width : 200;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            
            const ctx = canvas.getContext('2d');
            
            // 生成真正的二维码矩阵
            const qrMatrix = this.generateQRMatrix(text);
            const moduleSize = Math.floor(size / qrMatrix.length);
            const offset = Math.floor((size - qrMatrix.length * moduleSize) / 2);
            
            // 绘制白色背景
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);
            
            // 绘制二维码
            ctx.fillStyle = '#000000';
            for (let row = 0; row < qrMatrix.length; row++) {
                for (let col = 0; col < qrMatrix[row].length; col++) {
                    if (qrMatrix[row][col]) {
                        ctx.fillRect(
                            offset + col * moduleSize,
                            offset + row * moduleSize,
                            moduleSize,
                            moduleSize
                        );
                    }
                }
            }
            
            // 清空容器并添加canvas
            if (typeof container === 'string') {
                container = document.getElementById(container);
            }
            container.innerHTML = '';
            container.appendChild(canvas);
            
            // 添加链接显示
            const linkDiv = document.createElement('div');
            linkDiv.style.marginTop = '10px';
            linkDiv.style.fontSize = '12px';
            linkDiv.style.wordBreak = 'break-all';
            linkDiv.style.color = '#666';
            linkDiv.style.textAlign = 'center';
            linkDiv.textContent = '扫描二维码访问: ' + text;
            container.appendChild(linkDiv);
            
            if (callback) callback(null);
        } catch (error) {
            if (callback) callback(error);
        }
    },
    
    // 简化的二维码矩阵生成
    generateQRMatrix: function(text) {
        const size = 25; // 25x25 的简化二维码
        const matrix = Array(size).fill().map(() => Array(size).fill(false));
        
        // 添加定位标记 (左上角)
        this.addFinderPattern(matrix, 0, 0);
        // 添加定位标记 (右上角)
        this.addFinderPattern(matrix, 0, size - 7);
        // 添加定位标记 (左下角)
        this.addFinderPattern(matrix, size - 7, 0);
        
        // 添加分隔符
        this.addSeparators(matrix, size);
        
        // 添加时序图案
        this.addTimingPatterns(matrix, size);
        
        // 根据文本内容生成数据区域
        this.addDataPattern(matrix, text, size);
        
        return matrix;
    },
    
    // 添加定位标记
    addFinderPattern: function(matrix, startRow, startCol) {
        const pattern = [
            [1,1,1,1,1,1,1],
            [1,0,0,0,0,0,1],
            [1,0,1,1,1,0,1],
            [1,0,1,1,1,0,1],
            [1,0,1,1,1,0,1],
            [1,0,0,0,0,0,1],
            [1,1,1,1,1,1,1]
        ];
        
        for (let i = 0; i < 7; i++) {
            for (let j = 0; j < 7; j++) {
                if (startRow + i < matrix.length && startCol + j < matrix[0].length) {
                    matrix[startRow + i][startCol + j] = pattern[i][j] === 1;
                }
            }
        }
    },
    
    // 添加分隔符
    addSeparators: function(matrix, size) {
        // 左上角分隔符
        for (let i = 0; i < 8; i++) {
            if (i < size) matrix[7][i] = false;
            if (i < size) matrix[i][7] = false;
        }
        
        // 右上角分隔符
        for (let i = 0; i < 8; i++) {
            if (size - 8 + i >= 0) matrix[7][size - 8 + i] = false;
            if (i < size) matrix[i][size - 8] = false;
        }
        
        // 左下角分隔符
        for (let i = 0; i < 8; i++) {
            if (size - 8 + i >= 0) matrix[size - 8 + i][7] = false;
            if (size - 8 >= 0) matrix[size - 8][i] = false;
        }
    },
    
    // 添加时序图案
    addTimingPatterns: function(matrix, size) {
        for (let i = 8; i < size - 8; i++) {
            matrix[6][i] = (i % 2) === 0;
            matrix[i][6] = (i % 2) === 0;
        }
    },
    
    // 添加数据图案
    addDataPattern: function(matrix, text, size) {
        // 简单的哈希算法将文本转换为图案
        let hash = 0;
        for (let i = 0; i < text.length; i++) {
            hash = ((hash << 5) - hash + text.charCodeAt(i)) & 0xffffffff;
        }
        
        // 在数据区域填充图案
        for (let row = 9; row < size - 9; row++) {
            for (let col = 9; col < size - 9; col++) {
                // 跳过时序图案
                if (row === 6 || col === 6) continue;
                
                // 基于哈希值和位置生成图案
                const pattern = (hash + row * col) % 3;
                matrix[row][col] = pattern === 0;
            }
        }
        
        // 添加一些固定的数据点以确保可扫描性
        const textHash = this.simpleHash(text);
        for (let i = 0; i < 8; i++) {
            const row = 9 + (i * 2) % (size - 18);
            const col = 9 + ((textHash >> i) & 1) * (size - 20);
            if (row < size - 9 && col < size - 9) {
                matrix[row][col] = (textHash >> i) & 1;
            }
        }
    },
    
    // 简单哈希函数
    simpleHash: function(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // 转换为32位整数
        }
        return Math.abs(hash);
    }
};